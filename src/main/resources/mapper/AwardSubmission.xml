<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.com.code.certificateProcessor.mapper.AwardSubmissionMapper">

    <resultMap id="AwardSubmissionResultMap" type="AwardSubmission">
        <id property="id" column="id" /> <result property="submissionId" column="submissionId" />
        <result property="studentId" column="studentId" />
        <result property="imageUrl" column="imageUrl" />
        <result property="status" column="status" />
        <result property="matchedAwardId" column="matchedAwardId" />
        <result property="finalScore" column="finalScore" />
        <result property="rejectionReason" column="rejectionReason" />
        <result property="duplicateCheckResult" column="duplicateCheckResult" />
        <result property="reviewedBy" column="reviewedBy" />
        <result property="submittedAt" column="submittedAt" />
        <result property="completedAt" column="completedAt" />

        <result property="ocrFullText" column="ocrFullText"
                typeHandler="org.com.code.certificateProcessor.handler.JsonTypeHandler" />

        <result property="aiSuggestion" column="aiSuggestion"
                typeHandler="org.com.code.certificateProcessor.handler.JsonListTypeHandler" />
    </resultMap>

    <select id="getSubmissionURL" resultType="String">
        select imageUrl from award_submission
        where submissionId = #{submissionId} and studentId = #{studentId}
    </select>

    <select id="getSubmissionByMatchedAwardId" resultType="AwardSubmission">
        select submissionId,studentId, ocrFullText
               from award_submission
        where matchedAwardId = #{matchedAwardId} 
        and status = 'MANUAL_APPROVED'
        and studentId = #{studentId}
    </select>

    <insert id="addAwardSubmission" parameterType="map">
        insert into award_submission(submissionId,studentId, imageUrl)
        values(#{submissionId},#{studentId}, #{imageUrl})
    </insert>

    <delete id="deleteAwardSubmission">
        delete from award_submission
        where submissionId = #{submissionId} and studentId = #{studentId} and status = 'AI_PROCESSING'
    </delete>

    <select id="getAllSubmission" parameterType="map" resultType="AwardSubmissionResultMap">
        select submissionId, studentId,
               imageUrl, status, ocrFullText,
               matchedAwardId, finalScore, rejectionReason, aiSuggestion, duplicateCheckResult, reviewedBy, submittedAt, completedAt from award_submission
        where  studentId = #{studentId}
    </select>

    <update id="updateAwardSubmission" parameterType="map">
        UPDATE award_submission
        <set>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            <if test="ocrFullText != null and ocrFullText != ''">
                ocrFullText = #{ocrFullText,typeHandler=org.com.code.certificateProcessor.handler.JsonTypeHandler},
            </if>
            <if test="matchedAwardId != null and matchedAwardId != ''">
                matchedAwardId = #{matchedAwardId},
            </if>
            <if test="finalScore != null">
                finalScore = #{finalScore},
            </if>
            <if test="rejectionReason != null and rejectionReason != ''">
                rejectionReason = #{rejectionReason},
            </if>
            <if test="aiSuggestion != null and aiSuggestion != ''">
                aiSuggestion = #{aiSuggestion,typeHandler=org.com.code.certificateProcessor.handler.JsonListTypeHandler},
            </if>
            <if test="duplicateCheckResult != null and duplicateCheckResult != ''">
                duplicateCheckResult = #{duplicateCheckResult},
            </if>
            <if test="reviewedBy != null and reviewedBy != ''">
                reviewedBy = #{reviewedBy},
            </if>
            <if test="submittedAt != null">
                submittedAt = #{submittedAt},
            </if>
            <if test="completedAt != null">
                completedAt = #{completedAt}
            </if>
        </set>
        where submissionId = #{submissionId}
    </update>

    <!-- ULID 生成的 submissionId 虽然是字符串,但是基于精确时间戳生成的唯一ID,可以排序,
    基于ULID 越早生成的字符串ID越小 -->
    <select id="getLatterSubmission" resultType="AwardSubmission">
        select submissionId,studentId,imageUrl,status,
               ocrFullText,matchedAwardId,finalScore,rejectionReason,
               aiSuggestion,duplicateCheckResult,reviewedBy,
               submittedAt,completedAt
        from award_submission
        where submissionId &gt; #{lastId} and status = #{status}
        order by submissionId asc
        limit #{pageSize}
    </select>

    <select id="getPreviousSubmission" resultType="AwardSubmission">
        select submissionId, studentId, imageUrl, status,
        ocrFullText, matchedAwardId, finalScore, rejectionReason,
        aiSuggestion, duplicateCheckResult, reviewedBy,
        submittedAt, completedAt
        from award_submission
        where submissionId &lt; #{lastId} and status = #{status}
        order by id desc
        limit #{pageSize}
    </select>


    <select id="sumApprovedScoreByStudentIdList" parameterType="java.util.List" resultType="double">
        select coalesce(sum(finalScore), 0)
        from award_submission
        where studentId in
        <foreach collection="list" item="studentId" open="(" separator="," close=")">
            #{studentId}
        </foreach>
          and status = 'MANUAL_APPROVED'
    </select>

</mapper>